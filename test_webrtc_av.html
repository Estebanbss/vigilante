<!DOCTYPE html>
<html>
     <head>
          <title>WebRTC Audio + Video Test</title>
          <style>
               body {
                    font-family: Arial, sans-serif;
                    padding: 20px;
               }
               video {
                    border: 1px solid #ccc;
                    margin: 10px;
               }
               button {
                    padding: 10px 20px;
                    margin: 5px;
               }
               #status {
                    margin: 10px 0;
                    padding: 10px;
                    background: #f0f0f0;
               }
          </style>
     </head>
     <body>
          <h1>üé• WebRTC Audio + Video Test</h1>

          <div
               style="
                    background: #f0f0f0;
                    padding: 15px;
                    margin: 10px 0;
                    border-radius: 5px;
               "
          >
               <h3>üìã Instrucciones:</h3>
               <ol>
                    <li>
                         El token de autenticaci√≥n se carga autom√°ticamente del
                         archivo .env
                    </li>
                    <li>Haz click en "Connect WebRTC"</li>
                    <li>
                         Espera a que aparezca el video y se reproduzca el audio
                    </li>
               </ol>
               <p>
                    <strong>Token actual:</strong>
                    <code id="tokenDisplay">Cargando...</code>
               </p>
          </div>

          <div>
               <button id="connectBtn" onclick="connectWebRTC()">
                    Connect WebRTC
               </button>
               <button id="disconnectBtn" onclick="disconnectWebRTC()" disabled>
                    Disconnect
               </button>
          </div>

          <div id="status">Status: Disconnected</div>
          <div id="latency">Latency: -- ms</div>
          <div id="latency">Latency: -- ms</div>
          <video id="video" autoplay muted></video>
          <br />

          <button id="connectBtn" onclick="connectWebRTC()">
               üîó Connect WebRTC (Requiere Token)
          </button>
          <button id="disconnectBtn" onclick="disconnectWebRTC()" disabled>
               ‚ùå Disconnect
          </button>

          <script>
               let peerConnection = null;
               let isConnected = false;
               let latencyInterval = null;
               const video = document.getElementById("video");
               const status = document.getElementById("status");
               const tokenInput = document.getElementById("token");

               const BASE_URL = "https://stream.estebanbss.dev";
               const AUTH_TOKEN = "PrincessGoesToTheOnTheRun1"; // Token from .env file

               // Display token on page load
               document.addEventListener("DOMContentLoaded", function () {
                    document.getElementById("tokenDisplay").textContent =
                         AUTH_TOKEN;
               });

               async function connectWebRTC() {
                    try {
                         status.textContent = "Status: Connecting...";
                         document.getElementById("connectBtn").disabled = true;

                         // Crear peer connection
                         peerConnection = new RTCPeerConnection({
                              iceServers: [
                                   { urls: "stun:stun.l.google.com:19302" },
                              ],
                         });

                         // Configurar video y audio
                         peerConnection.ontrack = (event) => {
                              if (event.track.kind === "video") {
                                   video.srcObject = event.streams[0];
                              }
                         };

                         // Crear oferta
                         const offer = await peerConnection.createOffer();
                         await peerConnection.setLocalDescription(offer);

                         // Enviar oferta al servidor
                         const response = await fetch(
                              `${BASE_URL}/api/webrtc/offer`,
                              {
                                   method: "POST",
                                   headers: {
                                        "Content-Type": "application/json",
                                        Authorization: `Bearer ${AUTH_TOKEN}`,
                                   },
                                   body: JSON.stringify(offer),
                              }
                         );

                         if (!response.ok) {
                              throw new Error(
                                   `HTTP ${response.status}: ${response.statusText}`
                              );
                         }

                         const answer = await response.json();

                         // Configurar respuesta
                         await peerConnection.setRemoteDescription({
                              type: "answer",
                              sdp: answer.sdp,
                         });

                         isConnected = true;
                         status.textContent = "Status: Connected ‚úÖ";
                         document.getElementById(
                              "disconnectBtn"
                         ).disabled = false;

                         // Iniciar medici√≥n de latencia
                         startLatencyMeasurement();
                    } catch (error) {
                         console.error("Error connecting:", error);
                         status.textContent = `Status: Error - ${error.message}`;
                         document.getElementById("connectBtn").disabled = false;
                         disconnectWebRTC();
                    }
               }

               function disconnectWebRTC() {
                    if (peerConnection) {
                         peerConnection.close();
                         peerConnection = null;
                    }

                    isConnected = false;
                    status.textContent = "Status: Disconnected";
                    document.getElementById("latency").textContent =
                         "Latency: -- ms";
                    document.getElementById("connectBtn").disabled = false;
                    document.getElementById("disconnectBtn").disabled = true;

                    // Detener medici√≥n de latencia
                    if (latencyInterval) {
                         clearInterval(latencyInterval);
                         latencyInterval = null;
                    }

                    // Limpiar video
                    if (video.srcObject) {
                         video.srcObject
                              .getTracks()
                              .forEach((track) => track.stop());
                         video.srcObject = null;
                    }
               }

               function startLatencyMeasurement() {
                    latencyInterval = setInterval(async () => {
                         if (!isConnected || !peerConnection) return;

                         try {
                              const stats = await peerConnection.getStats();
                              let totalLatency = 0;
                              let count = 0;

                              stats.forEach((report) => {
                                   if (
                                        report.type === "inbound-rtp" &&
                                        report.kind === "video"
                                   ) {
                                        if (
                                             report.jitterBufferDelay &&
                                             report.jitterBufferEmittedCount
                                        ) {
                                             const avgJitterBufferDelay =
                                                  report.jitterBufferDelay /
                                                  report.jitterBufferEmittedCount;
                                             totalLatency +=
                                                  avgJitterBufferDelay * 1000; // Convertir a ms
                                             count++;
                                        }
                                   }
                              });

                              if (count > 0) {
                                   const avgLatency = Math.round(
                                        totalLatency / count
                                   );
                                   document.getElementById(
                                        "latency"
                                   ).textContent = `Latency: ${avgLatency} ms`;
                              }
                         } catch (error) {
                              console.warn("Error measuring latency:", error);
                         }
                    }, 1000);
               } // Cleanup on page unload
               window.addEventListener("beforeunload", disconnectWebRTC);
          </script>
     </body>
</html>
